<!doctype html>
<html lang="en" data-theme="light">
  <head>
    {{> head}}
  </head>
  <body class="bg-base-200 min-h-screen">
    <div x-data="trackerApp" class="flex min-h-screen flex-col">
      <!-- Header -->
      <header class="navbar bg-primary text-primary-content shadow-lg">
        <div class="flex-1">
          <h1 class="text-xl font-bold">Price Tracker</h1>
          <p class="ml-4 hidden text-sm opacity-80 sm:block">
            <a href="index.html" class="hover:underline">GSAU.gg</a> - Last 24 Hours
          </p>
        </div>
        <div class="flex-none">
          {{> theme-selector}}
        </div>
      </header>

      <!-- Main content -->
      <main class="flex-1 p-4">
        <div class="mx-auto max-w-6xl">
          <!-- Disclaimer banner -->
          <div class="alert mb-6">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              class="h-6 w-6 shrink-0 stroke-current"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <span
              >Times shown are when we detected changes, not when stores updated prices. We scan
              roughly every 30 minutes.</span
            >
          </div>

          <!-- Loading state -->
          <template x-if="loading">
            <div class="space-y-6">
              <!-- Summary skeletons -->
              <div class="grid grid-cols-3 gap-4">
                <template x-for="i in 3" :key="i">
                  <div class="card bg-base-100 p-4 shadow-md">
                    <div class="skeleton mx-auto h-8 w-16"></div>
                    <div class="skeleton mx-auto mt-2 h-3 w-20"></div>
                  </div>
                </template>
              </div>
              <!-- Table skeleton -->
              <div class="card bg-base-100 p-4 shadow-md">
                <div class="skeleton h-64 w-full"></div>
              </div>
            </div>
          </template>

          <!-- Error state -->
          <template x-if="error && !loading">
            <div class="flex justify-center py-12">
              <div class="alert alert-error max-w-md">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6 shrink-0 stroke-current"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <span x-text="`Error loading data: ${error}`"></span>
              </div>
            </div>
          </template>

          <!-- Content -->
          <template x-if="!loading && !error">
            <div class="space-y-6">
              <!-- Summary cards -->
              <div class="grid grid-cols-3 gap-4">
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div class="text-success text-3xl font-bold tabular-nums">
                    <span class="mr-1">↓</span><span x-text="stats.drops"></span>
                  </div>
                  <div class="text-base-content/70 text-sm">Price Drops</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div class="text-warning text-3xl font-bold tabular-nums">
                    <span class="mr-1">↑</span><span x-text="stats.increases"></span>
                  </div>
                  <div class="text-base-content/70 text-sm">Price Increases</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div class="text-info text-3xl font-bold tabular-nums">
                    <span class="mr-1">+</span><span x-text="stats.newItems"></span>
                  </div>
                  <div class="text-base-content/70 text-sm">New Products</div>
                </div>
              </div>

              <!-- Empty state -->
              <template x-if="allChanges.length === 0">
                <div class="card bg-base-100 p-8 text-center shadow-md">
                  <p class="text-base-content/70">No price changes or new products in the last 24 hours.</p>
                </div>
              </template>

              <!-- Changes table -->
              <template x-if="allChanges.length > 0">
                <div class="card bg-base-100 overflow-x-auto shadow-md">
                  <table class="table-zebra table">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Product</th>
                        <th>Store</th>
                        <th class="text-right">Price</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="change in allChanges" :key="change.id">
                        <tr>
                          <td class="whitespace-nowrap">
                            <span class="tooltip cursor-help" :data-tip="formatDate(change.timestamp)">
                              <span x-text="formatRelativeTime(change.timestamp)"></span>
                            </span>
                          </td>
                          <td class="whitespace-nowrap">
                            <template x-if="change.type === 'new'">
                              <span class="badge badge-info whitespace-nowrap">+ New</span>
                            </template>
                            <template x-if="change.type === 'price' && change.direction === 'down'">
                              <span class="badge badge-success whitespace-nowrap">↓ Drop</span>
                            </template>
                            <template x-if="change.type === 'price' && change.direction === 'up'">
                              <span class="badge badge-warning whitespace-nowrap">↑ Rise</span>
                            </template>
                          </td>
                          <td>
                            <div class="flex items-center gap-3">
                              <div class="avatar">
                                <div class="mask mask-squircle h-10 w-10">
                                  <img
                                    :src="change.productImage"
                                    :alt="change.productTitle"
                                    loading="lazy"
                                    onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><rect fill=%22%23ddd%22 width=%2224%22 height=%2224%22/><text x=%2212%22 y=%2216%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%228%22>?</text></svg>'"
                                  />
                                </div>
                              </div>
                              <div>
                                <a
                                  :href="getProductSearchUrl(change.productTitle)"
                                  class="link link-hover font-medium line-clamp-1"
                                  x-text="change.productTitle"
                                ></a>
                                <div
                                  class="text-base-content/60 text-xs"
                                  x-text="change.productCategory"
                                ></div>
                              </div>
                            </div>
                          </td>
                          <td>
                            <a
                              :href="addReferral(change.vendorUrl)"
                              @click="trackStoreClick(change.vendor)"
                              target="_blank"
                              rel="noopener"
                              class="link link-primary inline-flex items-center gap-1"
                            >
                              <span x-text="change.vendor"></span>
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-3 w-3"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                                />
                              </svg>
                            </a>
                          </td>
                          <td class="text-right">
                            <template x-if="change.type === 'new'">
                              <span class="font-semibold tabular-nums" x-text="`$${change.price.toFixed(2)}`"></span>
                            </template>
                            <template x-if="change.type === 'price'">
                              <div class="flex flex-col items-end">
                                <div class="flex items-center gap-2">
                                  <span
                                    class="text-base-content/60 line-through tabular-nums"
                                    x-text="`$${change.oldPrice.toFixed(2)}`"
                                  ></span>
                                  <span class="font-semibold tabular-nums" x-text="`$${change.newPrice.toFixed(2)}`"></span>
                                </div>
                                <span
                                  class="text-xs font-bold"
                                  :class="change.direction === 'down' ? 'text-success' : 'text-warning'"
                                  x-text="`${change.direction === 'down' ? '↓' : '↑'}${Math.abs(change.percentChange).toFixed(1)}%`"
                                ></span>
                              </div>
                            </template>
                          </td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </template>
            </div>
          </template>
        </div>
      </main>

      {{> footer}}
    </div>

    <script type="module" src="./js/app.js"></script>
  </body>
</html>
