<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scraper Status - GSAU.gg</title>
    <link rel="stylesheet" href="./css/main.css" />
  </head>
  <body class="bg-base-200 min-h-screen">
    <div x-data="statusApp" class="flex min-h-screen flex-col">
      <!-- Header -->
      <header class="navbar bg-primary text-primary-content shadow-lg">
        <div class="flex-1">
          <h1 class="text-xl font-bold">Scraper Status</h1>
          <p class="ml-4 hidden text-sm opacity-80 sm:block">
            <a href="index.html" class="hover:underline">GSAU.gg</a> - Store Statistics
          </p>
        </div>
        <div class="flex-none">
          <!-- Theme selector dropdown -->
          <div class="dropdown dropdown-end">
            <div
              tabindex="0"
              role="button"
              class="btn btn-ghost btn-sm gap-1"
              aria-label="Select theme"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
                />
              </svg>
              <span x-text="$store.theme.current" class="hidden capitalize sm:inline"></span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </div>
            <ul
              tabindex="0"
              class="dropdown-content menu rounded-box border-base-300 bg-base-100 text-base-content z-50 mt-2 w-52 border p-2 shadow-lg"
            >
              <template x-for="t in $store.theme.themes" :key="t">
                <li>
                  <button
                    @click="$store.theme.set(t)"
                    class="capitalize"
                    :class="{ 'bg-primary text-primary-content': $store.theme.current === t }"
                    x-text="t"
                  ></button>
                </li>
              </template>
            </ul>
          </div>
        </div>
      </header>

      <!-- Main content -->
      <main class="flex-1 p-4">
        <div class="mx-auto max-w-6xl">
          <!-- Loading state -->
          <template x-if="loading">
            <div class="space-y-6">
              <!-- Summary skeletons -->
              <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-7">
                <template x-for="i in 7" :key="i">
                  <div class="card bg-base-100 p-4 shadow-md">
                    <div class="skeleton mx-auto h-8 w-16"></div>
                    <div class="skeleton mx-auto mt-2 h-3 w-20"></div>
                  </div>
                </template>
              </div>
              <!-- Table skeleton -->
              <div class="card bg-base-100 p-4 shadow-md">
                <div class="skeleton h-64 w-full"></div>
              </div>
            </div>
          </template>

          <!-- Error state -->
          <template x-if="error && !loading">
            <div class="flex justify-center py-12">
              <div class="alert alert-error max-w-md">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6 shrink-0 stroke-current"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <span x-text="`Error loading stats: ${error}`"></span>
              </div>
            </div>
          </template>

          <!-- Stats content -->
          <template x-if="stats && !loading">
            <div class="space-y-6">
              <!-- Summary cards -->
              <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-7">
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div class="text-3xl font-bold" x-text="stats.stores.length"></div>
                  <div class="text-base-content/70 text-sm">Stores</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div
                    class="text-3xl font-bold tabular-nums"
                    x-text="stats.totals.rawProducts.toLocaleString()"
                  ></div>
                  <div class="text-base-content/70 text-sm">Fetched</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div
                    class="text-3xl font-bold tabular-nums"
                    x-text="totalFiltered.toLocaleString()"
                  ></div>
                  <div class="text-base-content/70 text-sm">Filtered</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div
                    class="text-3xl font-bold tabular-nums"
                    x-text="stats.totals.uniqueProducts.toLocaleString()"
                  ></div>
                  <div class="text-base-content/70 text-sm">Unique Products</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div
                    class="text-success text-3xl font-bold tabular-nums"
                    x-text="(stats.totals.inStock || 0).toLocaleString()"
                  ></div>
                  <div class="text-base-content/70 text-sm">In Stock</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div
                    class="text-error text-3xl font-bold tabular-nums"
                    x-text="(stats.totals.outOfStock || 0).toLocaleString()"
                  ></div>
                  <div class="text-base-content/70 text-sm">Out of Stock</div>
                </div>
                <div class="card bg-base-100 p-4 text-center shadow-md">
                  <div
                    class="text-3xl font-bold"
                    :class="errorCount > 0 ? 'text-error' : 'text-success'"
                    x-text="errorCount > 0 ? `${errorCount} Errors` : 'All OK'"
                  ></div>
                  <div class="text-base-content/70 text-sm">Status</div>
                </div>
              </div>

              <!-- Stores table -->
              <div class="card bg-base-100 overflow-x-auto shadow-md">
                <table class="table-zebra table">
                  <thead>
                    <tr>
                      <th>Store</th>
                      <th>Platform</th>
                      <th class="text-right">Fetched</th>
                      <th class="text-right">Filtered</th>
                      <th class="text-right">Final</th>
                      <th class="text-right">In Stock</th>
                      <th class="text-right">OOS</th>
                      <th class="text-right">Duration</th>
                      <th>Status</th>
                      <th>Log</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="store in stores" :key="store.name">
                      <tr>
                        <td>
                          <a
                            :href="store.url"
                            target="_blank"
                            rel="noopener"
                            class="link link-primary"
                            x-text="store.name"
                          ></a>
                        </td>
                        <td>
                          <span
                            class="badge badge-sm font-semibold uppercase"
                            :class="{
                              'bg-[#95bf47] text-white': store.platform === 'shopify',
                              'bg-[#96588a] text-white': store.platform === 'woocommerce',
                              'bg-[#222] text-white': store.platform === 'squarespace'
                            }"
                            x-text="store.platform"
                          ></span>
                        </td>
                        <td
                          class="text-right tabular-nums"
                          x-text="store.fetched.toLocaleString()"
                        ></td>
                        <td class="text-right tabular-nums">
                          <button
                            x-show="store.filtered > 0"
                            @click="showFilteredProducts(store)"
                            class="link link-primary"
                            x-text="store.filtered.toLocaleString()"
                          ></button>
                          <span x-show="store.filtered === 0">0</span>
                        </td>
                        <td
                          class="text-right tabular-nums"
                          x-text="store.final.toLocaleString()"
                        ></td>
                        <td
                          class="text-success text-right tabular-nums"
                          x-text="(store.inStock || 0).toLocaleString()"
                        ></td>
                        <td
                          class="text-error text-right tabular-nums"
                          x-text="(store.outOfStock || 0).toLocaleString()"
                        ></td>
                        <td
                          class="text-right tabular-nums"
                          x-text="`${store.duration.toFixed(1)}s`"
                        ></td>
                        <td>
                          <template x-if="store.error">
                            <span class="text-error" x-text="store.error"></span>
                          </template>
                          <template x-if="!store.error">
                            <span class="text-success">âœ“</span>
                          </template>
                        </td>
                        <td>
                          <button
                            @click="showLogs(store)"
                            class="btn btn-xs btn-ghost"
                            :class="{'text-warning': store.logs?.some(l => l.level === 'WARNING'), 'text-error': store.logs?.some(l => l.level === 'ERROR')}"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              class="h-4 w-4"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke="currentColor"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                              />
                            </svg>
                          </button>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>

              <!-- Log Modal -->
              <dialog id="logModal" class="modal" :class="{'modal-open': selectedStore}">
                <div class="modal-box max-w-2xl">
                  <h3 class="text-lg font-bold" x-text="selectedStore?.name + ' - Scrape Log'"></h3>
                  <div class="mt-4 max-h-96 overflow-y-auto">
                    <template x-if="selectedStore?.logs?.length > 0">
                      <div class="space-y-1 font-mono text-sm">
                        <template x-for="(log, i) in selectedStore.logs" :key="i">
                          <div
                            class="flex gap-2 rounded px-2 py-1"
                            :class="{
                              'bg-success/10': log.level === 'INFO',
                              'bg-warning/20': log.level === 'WARNING',
                              'bg-error/20': log.level === 'ERROR'
                            }"
                          >
                            <span class="opacity-60" x-text="log.time"></span>
                            <span
                              class="font-semibold"
                              :class="{
                                'text-success': log.level === 'INFO',
                                'text-warning': log.level === 'WARNING',
                                'text-error': log.level === 'ERROR'
                              }"
                              x-text="log.level"
                            ></span>
                            <span x-text="log.message"></span>
                          </div>
                        </template>
                      </div>
                    </template>
                    <template x-if="!selectedStore?.logs?.length">
                      <p class="text-base-content/50 text-center">No logs available</p>
                    </template>
                  </div>
                  <div class="modal-action">
                    <button class="btn" @click="selectedStore = null">Close</button>
                  </div>
                </div>
                <form method="dialog" class="modal-backdrop">
                  <button @click="selectedStore = null">close</button>
                </form>
              </dialog>

              <!-- Filtered Products Modal -->
              <dialog id="filteredModal" class="modal" :class="{'modal-open': selectedStoreFiltered}">
                <div class="modal-box max-w-3xl">
                  <h3 class="text-lg font-bold">
                    <span x-text="selectedStoreFiltered?.name"></span> - Filtered Products
                    <span class="badge badge-neutral ml-2" x-text="selectedStoreFiltered?.filteredProducts?.length || 0"></span>
                  </h3>
                  <div class="mt-4 max-h-[60vh] overflow-y-auto">
                    <template x-if="selectedStoreFiltered?.filteredProducts?.length > 0">
                      <div class="space-y-2">
                        <template x-for="(item, i) in selectedStoreFiltered.filteredProducts" :key="i">
                          <div class="bg-base-200 rounded-lg p-3">
                            <div class="font-medium" x-text="item.title"></div>
                            <div class="text-base-content/70 mt-1 text-sm">
                              <span class="capitalize" x-text="item.reason"></span>
                              matched "<span class="font-mono text-warning" x-text="item.keyword"></span>"
                              <span class="opacity-60">(<span x-text="item.filterCategory"></span>)</span>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <template x-if="!selectedStoreFiltered?.filteredProducts?.length">
                      <p class="text-base-content/50 text-center py-8">No filtered products data available</p>
                    </template>
                  </div>
                  <div class="modal-action">
                    <button class="btn" @click="selectedStoreFiltered = null">Close</button>
                  </div>
                </div>
                <form method="dialog" class="modal-backdrop">
                  <button @click="selectedStoreFiltered = null">close</button>
                </form>
              </dialog>

              <!-- Last updated -->
              <p class="text-base-content/70 text-center text-sm">
                Last updated:
                <span x-text="formatDate(stats.lastUpdated)"></span>
                (<span x-text="`${stats.duration.toFixed(1)}s total`"></span>)
              </p>
            </div>
          </template>
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer footer-center bg-base-300 text-base-content p-4">
        <div class="flex flex-wrap justify-center gap-4">
          <a href="index.html" class="link link-primary">Price Comparison</a>
          <a href="tracker.html" class="link link-primary">Price Tracker</a>
          <span class="opacity-70">Scraper Status</span>
          <a href="about.html" class="link link-primary">About</a>
        </div>
      </footer>
    </div>

    <script type="module" src="./js/app.js"></script>
  </body>
</html>
