<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GSAU.gg - Price Comparison</title>
    <link rel="stylesheet" href="./css/main.css" />
  </head>
  <body class="bg-base-200 min-h-screen">
    <div x-data="productApp" class="flex min-h-screen flex-col">
      <!-- Skip link -->
      <a
        href="#products"
        class="focus:bg-primary focus:text-primary-content sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:rounded focus:px-4 focus:py-2"
      >
        Skip to products
      </a>

      <!-- Header -->
      <header class="navbar bg-primary text-primary-content shadow-lg sticky top-0 z-40">
        <div class="flex-none">
          <a href="#" @click.prevent="window.scrollTo({top: 0, behavior: 'smooth'})" class="text-xl font-bold hover:opacity-80 cursor-pointer">GSAU.gg</a>
        </div>
        <div class="mx-4 max-w-md flex-1">
          <input
            type="text"
            id="search"
            x-model.debounce.300ms="search"
            placeholder="Search products... (press /)"
            class="input input-sm input-bordered bg-primary-content/10 text-primary-content placeholder:text-primary-content/50 w-full"
          />
        </div>
        <div class="flex-none">
          <!-- Theme selector dropdown -->
          <div class="dropdown dropdown-end">
            <div
              tabindex="0"
              role="button"
              class="btn btn-ghost btn-sm gap-1"
              aria-label="Select theme"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
                />
              </svg>
              <span x-text="$store.theme.current" class="hidden capitalize sm:inline"></span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </div>
            <ul
              tabindex="0"
              class="dropdown-content menu rounded-box border-base-300 bg-base-100 text-base-content z-50 mt-2 w-52 border p-2 shadow-lg"
            >
              <template x-for="t in $store.theme.themes" :key="t">
                <li>
                  <button
                    @click="$store.theme.set(t)"
                    class="capitalize"
                    :class="{ 'bg-primary text-primary-content': $store.theme.current === t }"
                    x-text="t"
                  ></button>
                </li>
              </template>
            </ul>
          </div>
        </div>
      </header>

      <!-- Main content -->
      <main class="flex flex-1 flex-col lg:flex-row">
        <!-- Mobile filter toggle -->
        <button
          @click="sidebarOpen = !sidebarOpen"
          class="btn btn-outline m-4 lg:hidden"
          aria-label="Toggle product filters"
          :aria-expanded="sidebarOpen"
          aria-controls="filter-sidebar"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
          Filters
        </button>

        <!-- Mobile backdrop -->
        <div
          x-show="sidebarOpen"
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="transition ease-in duration-150"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
          class="fixed inset-0 z-40 bg-black/50 lg:hidden"
          @click="sidebarOpen = false"
        ></div>

        <!-- Sidebar -->
        <aside
          id="filter-sidebar"
          class="border-base-300 bg-base-100 fixed inset-y-0 left-0 z-50 w-72 shrink-0 transform overflow-x-hidden overflow-y-auto border-r p-4 shadow-lg transition-transform duration-200 ease-out lg:relative lg:z-auto lg:translate-x-0 lg:shadow-md"
          :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'"
          :aria-hidden="!sidebarOpen"
          aria-label="Product filters"
        >
          <!-- Mobile close button -->
          <div class="mb-4 flex items-center justify-between lg:hidden">
            <span class="font-semibold">Filters</span>
            <button
              @click="sidebarOpen = false"
              class="btn btn-ghost btn-sm btn-circle"
              aria-label="Close filters"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Clear filters button -->
          <button
            @click="clearFilters()"
            class="btn btn-ghost btn-sm mb-2 w-full"
            x-show="search || category || selectedVendors.length > 0 || stock !== 'instock' || minPrice || maxPrice || sort !== 'discount-pct' || searchTags"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
            Clear All Filters
          </button>

          <div class="space-y-4">
            <!-- Category filter -->
            <div class="form-control">
              <label class="label" for="category">
                <span class="label-text font-semibold">Category</span>
              </label>
              <select
                id="category"
                x-model="category"
                class="select select-sm border-base-300 bg-base-100 w-full rounded-lg border"
              >
                <option value="">All Categories</option>
                <template x-for="cat in categories" :key="cat">
                  <option :value="cat" x-text="cat"></option>
                </template>
              </select>
            </div>

            <!-- Store filter (multi-select) -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Stores</span>
                <span
                  class="label-text-alt text-primary"
                  x-show="selectedVendors.length > 0"
                  x-text="`${selectedVendors.length} selected`"
                ></span>
              </label>
              <div class="collapse-arrow border-base-300 bg-base-100 collapse rounded-lg border">
                <input type="checkbox" class="min-h-0" />
                <div class="collapse-title min-h-0 px-4 py-3 text-sm font-medium">
                  <span x-show="selectedVendors.length === 0" class="text-base-content/70"
                    >All Stores</span
                  >
                  <span
                    x-show="selectedVendors.length > 0"
                    x-text="selectedVendors.slice(0, 2).join(', ') + (selectedVendors.length > 2 ? ` +${selectedVendors.length - 2} more` : '')"
                  ></span>
                </div>
                <div class="collapse-content px-2 pb-2">
                  <div class="max-h-48 space-y-1 overflow-y-auto">
                    <template x-for="v in vendors" :key="v">
                      <label
                        class="hover:bg-base-200 flex cursor-pointer items-center gap-3 rounded px-2 py-1.5 transition-colors"
                      >
                        <input
                          type="checkbox"
                          :value="v"
                          :checked="selectedVendors.includes(v)"
                          @change="selectedVendors.includes(v) ? selectedVendors = selectedVendors.filter(x => x !== v) : selectedVendors = [...selectedVendors, v]"
                          class="checkbox checkbox-sm checkbox-primary"
                        />
                        <span class="text-sm" x-text="v"></span>
                      </label>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stock filter -->
            <div class="form-control">
              <label class="label" for="stock">
                <span class="label-text font-semibold">Stock</span>
              </label>
              <select
                id="stock"
                x-model="stock"
                class="select select-sm border-base-300 bg-base-100 w-full rounded-lg border"
              >
                <option value="instock">In Stock Only</option>
                <option value="">All Stock</option>
              </select>
            </div>

            <!-- Price range filter -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Price Range</span>
              </label>
              <div class="flex gap-2">
                <input
                  type="number"
                  x-model.number.debounce.500ms="minPrice"
                  placeholder="Min"
                  class="input input-sm border-base-300 bg-base-100 w-1/2 rounded-lg border"
                  min="0"
                  step="1"
                />
                <input
                  type="number"
                  x-model.number.debounce.500ms="maxPrice"
                  placeholder="Max"
                  class="input input-sm border-base-300 bg-base-100 w-1/2 rounded-lg border"
                  min="0"
                  step="1"
                />
              </div>
            </div>

            <!-- Show Vendors filter -->
            <div class="form-control">
              <label class="label" for="showVendors">
                <span class="label-text font-semibold">Show Vendors</span>
              </label>
              <select
                id="showVendors"
                x-model="showVendors"
                class="select select-sm border-base-300 bg-base-100 w-full rounded-lg border"
              >
                <option value="best">Best Price Only</option>
                <option value="all">All Vendors</option>
              </select>
            </div>

            <!-- Sort -->
            <div class="form-control">
              <label class="label" for="sort">
                <span class="label-text font-semibold">Sort By</span>
              </label>
              <select
                id="sort"
                x-model="sort"
                class="select select-sm border-base-300 bg-base-100 w-full rounded-lg border"
              >
                <option value="relevance">Relevance</option>
                <option value="discount-pct">Biggest Discount (%)</option>
                <option value="discount-dollars">Biggest Discount ($)</option>
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
                <option value="name-asc">Name: A to Z</option>
                <option value="name-desc">Name: Z to A</option>
              </select>
            </div>

            <!-- Per page -->
            <div class="form-control">
              <label class="label" for="perPage">
                <span class="label-text font-semibold">Per Page</span>
              </label>
              <select
                id="perPage"
                x-model="perPage"
                class="select select-sm border-base-300 bg-base-100 w-full rounded-lg border"
              >
                <option value="30">30</option>
                <option value="60">60</option>
                <option value="120">120</option>
                <option value="all">All</option>
              </select>
            </div>

            <!-- Search tags toggle -->
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-3">
                <input
                  type="checkbox"
                  x-model="searchTags"
                  class="checkbox checkbox-sm checkbox-primary"
                />
                <span class="label-text">Include tags in search</span>
                <div
                  class="tooltip tooltip-right"
                  data-tip="Also search tags set by vendors. May include less relevant results."
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="text-base-content/50 h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                </div>
              </label>
            </div>

            <!-- Stats -->
            <div class="border-base-300 mt-4 border-t pt-4">
              <div class="grid grid-cols-2 gap-2 text-center">
                <div class="bg-base-200 rounded-lg p-2">
                  <div class="text-primary text-lg font-bold" x-text="allProducts.length.toLocaleString()"></div>
                  <div class="text-base-content/70 text-xs">Products</div>
                </div>
                <div class="bg-base-200 rounded-lg p-2">
                  <div class="text-secondary text-lg font-bold" x-text="vendors.length"></div>
                  <div class="text-base-content/70 text-xs">Stores</div>
                </div>
              </div>
              <div class="text-base-content/70 mt-2 text-center text-xs" x-show="lastUpdated">
                Updated: <span x-text="lastUpdated"></span>
              </div>
              <div class="mt-2 flex justify-center gap-3 text-xs">
                <a href="status.html" class="link link-primary">Status</a>
                <a href="about.html" class="link link-primary">About</a>
              </div>
            </div>

            <!-- Discord link -->
            <div class="mt-4">
              <a
                href="https://discord.gg/fxsqEP3"
                target="_blank"
                rel="noopener"
                class="btn btn-outline btn-sm w-full gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"
                  />
                </svg>
                Join Gelsoft AU Discord
              </a>
            </div>
          </div>
        </aside>

        <!-- Content area -->
        <div class="flex-1 p-4">
          <!-- Stats bar -->
          <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
            <span class="text-base-content/70 text-sm">
              <template x-if="!loading">
                <span
                  x-text="`Showing ${displayedProducts.length} of ${filteredProducts.length} products`"
                ></span>
              </template>
              <template x-if="loading">
                <span class="skeleton h-4 w-32"></span>
              </template>
            </span>
            <div class="flex items-center gap-2">
              <span
                class="text-base-content/70 text-sm"
                x-show="lastUpdated"
                x-text="`Updated: ${lastUpdated}`"
              ></span>
              <!-- View toggle -->
              <div class="flex gap-1">
                <button
                  @click="viewMode = 'card'"
                  class="btn btn-ghost btn-sm btn-square"
                  :class="{ 'btn-active': viewMode === 'card' }"
                  aria-label="Card view"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                    />
                  </svg>
                </button>
                <button
                  @click="viewMode = 'list'"
                  class="btn btn-ghost btn-sm btn-square"
                  :class="{ 'btn-active': viewMode === 'list' }"
                  aria-label="List view"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Screen reader announcements -->
          <div
            role="status"
            aria-live="polite"
            aria-atomic="true"
            class="sr-only"
            x-text="!loading ? `Showing ${displayedProducts.length} of ${filteredProducts.length} products` : 'Loading products'"
          ></div>

          <!-- Products grid -->
          <section id="products">
            <!-- Loading skeletons -->
            <template x-if="loading">
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                <template x-for="i in 8" :key="i">
                  <div class="card bg-base-100 shadow-md">
                    <figure class="skeleton h-48 w-full"></figure>
                    <div class="card-body">
                      <div class="skeleton h-4 w-3/4"></div>
                      <div class="skeleton h-3 w-1/2"></div>
                      <div class="skeleton h-6 w-1/3"></div>
                    </div>
                  </div>
                </template>
              </div>
            </template>

            <!-- Error state -->
            <template x-if="error && !loading">
              <div class="flex flex-col items-center justify-center py-12">
                <div class="alert alert-error max-w-md">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6 shrink-0 stroke-current"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span x-text="error"></span>
                </div>
              </div>
            </template>

            <!-- No results -->
            <template x-if="!loading && !error && filteredProducts.length === 0">
              <div class="text-base-content/70 flex flex-col items-center justify-center py-12">
                <p class="text-lg">No products found matching your criteria.</p>
                <p class="text-sm">Try adjusting your search or filters.</p>
              </div>
            </template>

            <!-- Products -->
            <template x-if="!loading && !error && filteredProducts.length > 0">
              <div>
                <!-- Card view -->
                <div
                  x-show="viewMode === 'card'"
                  class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
                >
                  <template x-for="product in displayedProducts" :key="product.title">
                    <article
                      class="card bg-base-100 shadow-md transition-all duration-200 hover:scale-[1.02] hover:shadow-lg"
                      :class="{ 'opacity-60': !product.inStock }"
                    >
                      <a
                        :href="addReferral(product.vendors?.[0]?.url) || '#'"
                        target="_blank"
                        rel="noopener"
                        class="block"
                      >
                        <figure class="bg-base-300 relative h-48 overflow-visible">
                          <img
                            x-show="product.image"
                            :src="product.image"
                            :alt="product.title"
                            class="h-full w-full object-contain"
                            loading="lazy"
                            @error="$el.classList.add('hidden'); $el.nextElementSibling.classList.remove('hidden')"
                          />
                          <div
                            class="text-base-content/30 flex h-full w-full items-center justify-center"
                            :class="product.image ? 'hidden' : ''"
                          >
                            No Image
                          </div>
                          <!-- Discount badge -->
                          <template x-if="getDiscountPercent(product) >= 1">
                            <div class="badge badge-error absolute top-2 right-2 font-bold">
                              <span
                                x-text="`${Math.round(getDiscountPercent(product))}% OFF`"
                              ></span>
                            </div>
                          </template>
                          <!-- Price change badge -->
                          <template x-if="getPriceChange(product)">
                            <button
                              @click.prevent="openPriceChart(product)"
                              class="badge absolute top-2 left-2 font-bold tooltip tooltip-bottom tooltip-wrap cursor-pointer hover:scale-110 transition-transform z-10"
                              :class="getPriceChange(product).direction === 'down' ? 'badge-success' : 'badge-warning'"
                              :data-tip="getPriceChange(product).direction === 'down'
                                ? `Price dropped from $${getPriceChange(product).previousPrice.toFixed(2)} this week`
                                : `Price increased from $${getPriceChange(product).previousPrice.toFixed(2)} this week`"
                            >
                              <span
                                x-text="(getPriceChange(product).direction === 'down' ? '↓' : '↑') + Math.round(getPriceChange(product).percent) + '%'"
                              ></span>
                            </button>
                          </template>
                        </figure>
                      </a>
                      <div class="card-body p-4">
                        <a
                          :href="addReferral(product.vendors?.[0]?.url) || '#'"
                          target="_blank"
                          rel="noopener"
                          class="card-title hover:text-primary line-clamp-2 text-sm"
                          x-text="product.title"
                        ></a>
                        <p class="text-base-content/70 text-xs">
                          <span x-text="product.vendors?.[0]?.name || ''"></span>
                          <button
                            x-show="product.vendors?.length > 1 && showVendors === 'best'"
                            @click.prevent="toggleExpanded(product.id)"
                            class="badge badge-ghost badge-xs hover:badge-primary ml-1 cursor-pointer"
                            x-text="isExpanded(product.id) ? 'collapse' : `+${product.vendors.length - 1} more`"
                          ></button>
                        </p>
                        <template x-if="product.category">
                          <span
                            class="badge badge-outline badge-sm"
                            x-text="product.category"
                          ></span>
                        </template>
                        <div class="mt-2 flex flex-wrap items-center gap-2">
                          <span
                            class="text-primary text-lg font-bold"
                            x-text="`$${product.lowestPrice.toFixed(2)}`"
                          ></span>
                          <template x-if="product.vendors?.[0]?.comparePrice">
                            <span
                              class="text-base-content/60 text-sm line-through"
                              x-text="`$${product.vendors[0].comparePrice.toFixed(2)}`"
                            ></span>
                          </template>
                          <!-- Price chart button -->
                          <button
                            x-show="priceHistory[product.id]"
                            @click.prevent="openPriceChart(product)"
                            class="btn btn-ghost btn-xs btn-circle"
                            aria-label="View price history"
                            title="View price history"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                            </svg>
                          </button>
                          <span
                            class="badge ml-auto"
                            :class="product.inStock ? 'badge-success' : 'badge-error'"
                            x-text="product.inStock ? 'In Stock' : 'Out of Stock'"
                          ></span>
                        </div>

                        <!-- View at Store button -->
                        <a
                          :href="addReferral(product.vendors?.[0]?.url) || '#'"
                          target="_blank"
                          rel="noopener"
                          class="btn btn-primary btn-sm mt-2 w-full"
                        >
                          View at Store →
                        </a>

                        <!-- Other vendors -->
                        <template
                          x-if="(showVendors === 'all' || isExpanded(product.id)) && product.vendors?.length > 1"
                        >
                          <div class="border-base-200 mt-3 space-y-1 border-t pt-3">
                            <template x-for="vendor in product.vendors.slice(1)" :key="vendor.url">
                              <a
                                :href="addReferral(vendor.url)"
                                target="_blank"
                                rel="noopener"
                                class="bg-base-200/50 hover:bg-base-200 flex items-center justify-between rounded px-2 py-1 text-xs"
                                :class="{ 'opacity-50': !vendor.inStock }"
                              >
                                <span x-text="vendor.name" class="truncate"></span>
                                <span class="flex items-center gap-1.5">
                                  <span
                                    x-text="`$${vendor.price.toFixed(2)}`"
                                    class="font-semibold"
                                  ></span>
                                  <template x-if="vendor.comparePrice">
                                    <span
                                      class="text-base-content/60 line-through"
                                      x-text="`$${vendor.comparePrice.toFixed(2)}`"
                                    ></span>
                                  </template>
                                  <span
                                    class="tooltip tooltip-left"
                                    :data-tip="vendor.inStock ? 'In Stock' : 'Out of Stock'"
                                  >
                                    <span
                                      class="inline-block h-2 w-2 rounded-full"
                                      :class="vendor.inStock ? 'bg-success' : 'bg-error'"
                                    ></span>
                                  </span>
                                </span>
                              </a>
                            </template>
                          </div>
                        </template>
                      </div>
                    </article>
                  </template>
                </div>

                <!-- List view -->
                <div x-show="viewMode === 'list'" class="space-y-2">
                  <template x-for="product in displayedProducts" :key="product.title">
                    <article
                      class="card bg-base-100 shadow-sm transition-shadow hover:shadow-md"
                      :class="{ 'opacity-60': !product.inStock }"
                    >
                      <div class="flex items-center">
                        <figure class="bg-base-300 h-20 w-20 shrink-0">
                          <img
                            x-show="product.image"
                            :src="product.image"
                            :alt="product.title"
                            class="h-full w-full object-contain"
                            loading="lazy"
                          />
                          <div
                            class="text-base-content/30 flex h-full w-full items-center justify-center text-xs"
                            :class="product.image ? 'hidden' : ''"
                          >
                            No Img
                          </div>
                        </figure>
                        <div class="flex flex-1 items-center gap-4 p-3">
                          <div class="min-w-0 flex-1">
                            <a
                              :href="addReferral(product.vendors?.[0]?.url) || '#'"
                              target="_blank"
                              rel="noopener"
                              class="hover:text-primary line-clamp-1 font-medium"
                              x-text="product.title"
                            ></a>
                            <p class="text-base-content/70 text-xs">
                              <span x-text="product.vendors?.[0]?.name || ''"></span>
                              <button
                                x-show="product.vendors?.length > 1 && showVendors === 'best'"
                                @click.prevent="toggleExpanded(product.id)"
                                class="badge badge-ghost badge-xs hover:badge-primary ml-1 cursor-pointer"
                                x-text="isExpanded(product.id) ? 'collapse' : `+${product.vendors.length - 1} more`"
                              ></button>
                            </p>
                          </div>
                          <div class="shrink-0 text-right">
                            <span
                              class="text-primary font-bold"
                              x-text="`$${product.lowestPrice.toFixed(2)}`"
                            ></span>
                            <template x-if="product.vendors?.[0]?.comparePrice">
                              <span
                                class="text-base-content/60 ml-1 text-xs line-through"
                                x-text="`$${product.vendors[0].comparePrice.toFixed(2)}`"
                              ></span>
                            </template>
                          </div>
                          <template x-if="getDiscountPercent(product) >= 1">
                            <span
                              class="badge badge-error badge-sm"
                              x-text="`${Math.round(getDiscountPercent(product))}%`"
                            ></span>
                          </template>
                          <!-- Price change badge (list view) -->
                          <template x-if="getPriceChange(product)">
                            <button
                              @click.prevent="openPriceChart(product)"
                              class="badge badge-sm tooltip tooltip-bottom tooltip-wrap cursor-pointer hover:scale-110 transition-transform"
                              :class="getPriceChange(product).direction === 'down' ? 'badge-success' : 'badge-warning'"
                              :data-tip="getPriceChange(product).direction === 'down'
                                ? `Price dropped from $${getPriceChange(product).previousPrice.toFixed(2)} this week`
                                : `Price increased from $${getPriceChange(product).previousPrice.toFixed(2)} this week`"
                              x-text="(getPriceChange(product).direction === 'down' ? '↓' : '↑') + Math.round(getPriceChange(product).percent) + '%'"
                            ></button>
                          </template>
                          <span
                            class="badge badge-sm"
                            :class="product.inStock ? 'badge-success' : 'badge-error'"
                            x-text="product.inStock ? 'In Stock' : 'OOS'"
                          ></span>
                          <!-- Price chart button (list view) -->
                          <button
                            x-show="priceHistory[product.id]"
                            @click.prevent="openPriceChart(product)"
                            class="btn btn-ghost btn-xs btn-circle"
                            aria-label="View price history"
                            title="View price history"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                            </svg>
                          </button>
                          <a
                            :href="addReferral(product.vendors?.[0]?.url) || '#'"
                            target="_blank"
                            rel="noopener"
                            class="btn btn-primary btn-sm"
                          >
                            View
                          </a>
                        </div>
                      </div>
                      <!-- Expanded vendors in list view -->
                      <template
                        x-if="(showVendors === 'all' || isExpanded(product.id)) && product.vendors?.length > 1"
                      >
                        <div class="border-base-200 mx-3 mb-3 space-y-1 border-t pt-2">
                          <template x-for="vendor in product.vendors.slice(1)" :key="vendor.url">
                            <a
                              :href="addReferral(vendor.url)"
                              target="_blank"
                              rel="noopener"
                              class="bg-base-200/50 hover:bg-base-200 flex items-center justify-between rounded px-2 py-1 text-xs"
                              :class="{ 'opacity-50': !vendor.inStock }"
                            >
                              <span x-text="vendor.name" class="truncate"></span>
                              <span class="flex items-center gap-1.5">
                                <span
                                  x-text="`$${vendor.price.toFixed(2)}`"
                                  class="font-semibold"
                                ></span>
                                <template x-if="vendor.comparePrice">
                                  <span
                                    class="text-base-content/60 line-through"
                                    x-text="`$${vendor.comparePrice.toFixed(2)}`"
                                  ></span>
                                </template>
                                <span
                                  class="tooltip tooltip-left"
                                  :data-tip="vendor.inStock ? 'In Stock' : 'Out of Stock'"
                                >
                                  <span
                                    class="inline-block h-2 w-2 rounded-full"
                                    :class="vendor.inStock ? 'bg-success' : 'bg-error'"
                                  ></span>
                                </span>
                              </span>
                            </a>
                          </template>
                        </div>
                      </template>
                    </article>
                  </template>
                </div>

                <!-- Infinite scroll sentinel -->
                <div id="scroll-sentinel" class="h-1"></div>

                <!-- Load more button (fallback for non-JS or manual load) -->
                <template x-if="hasMore">
                  <div class="mt-6 flex justify-center">
                    <button @click="loadMore()" class="btn btn-outline btn-sm">
                      Load More (<span x-text="remainingCount"></span> remaining)
                    </button>
                  </div>
                </template>
              </div>
            </template>
          </section>
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer footer-center bg-base-300 text-base-content p-4">
        <div class="flex flex-wrap justify-center gap-4 text-sm">
          <a href="status.html" class="link link-hover">Status</a>
          <a href="about.html" class="link link-hover">About</a>
          <a
            href="https://discord.gg/fxsqEP3"
            target="_blank"
            rel="noopener"
            class="link link-hover"
          >Discord</a>
        </div>
      </footer>

      <!-- Price History Chart Modal -->
      <template x-if="chartModal">
        <div
          class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
          @click.self="closePriceChart()"
          @keydown.escape.window="closePriceChart()"
        >
          <div class="bg-base-100 w-full max-w-3xl rounded-lg shadow-xl">
            <div class="border-base-300 flex items-center justify-between border-b p-4">
              <h3 class="line-clamp-1 text-lg font-semibold" x-text="chartModal.product.title"></h3>
              <button
                @click="closePriceChart()"
                class="btn btn-ghost btn-sm btn-circle"
                aria-label="Close"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div class="p-4">
              <div class="h-80">
                <canvas x-init="$nextTick(() => $nextTick(() => renderPriceChart($el)))"></canvas>
              </div>
              <p class="text-base-content/60 mt-2 text-center text-xs">
                Price history over the last 30 days. Click legend to toggle vendors.
              </p>
            </div>
          </div>
        </div>
      </template>

      <!-- Toast notification -->
      <template x-if="toast">
        <div class="toast toast-end toast-top z-50">
          <div
            class="alert"
            :class="{
              'alert-info': toast.type === 'info',
              'alert-success': toast.type === 'success',
              'alert-warning': toast.type === 'warning',
              'alert-error': toast.type === 'error'
            }"
          >
            <span x-text="toast.message"></span>
          </div>
        </div>
      </template>

      <!-- Go to top button -->
      <button
        x-show="showScrollTop"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-90"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-90"
        @click="scrollToTop()"
        class="btn btn-circle btn-primary fixed bottom-6 right-6 z-50 shadow-lg"
        aria-label="Scroll to top"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 15l7-7 7 7"
          />
        </svg>
      </button>
    </div>

    <script type="module" src="./js/app.js"></script>
  </body>
</html>
